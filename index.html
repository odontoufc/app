<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guia Clínico - Odontologia</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0e7490', 
                        secondary: '#155e75', 
                        accent: '#ecfeff',
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>

    <style>
        html { scroll-behavior: smooth; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .btn-card { transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; }
        .btn-card:active { transform: scale(0.98); }
        @media (hover: hover) {
            .btn-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #0e7490; }
        }

        /* Animations */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeInView 0.3s ease; }
        @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .tab-btn.active { color: #0e7490; border-bottom: 2px solid #0e7490; background-color: #ecfeff; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: #0e7490; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo para Texto Puro (Preserva quebras de linha e espaços) */
        .pre-wrap-text {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen text-base antialiased">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 w-full">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer active:opacity-70 transition-opacity" onclick="navigateTo('home')">
                <div class="bg-primary/10 p-2 rounded-lg text-primary">
                    <i data-lucide="book-open-check" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 tracking-tight leading-tight">Guia Clínico</h1>
                    <p class="text-[10px] text-gray-500 font-medium leading-none">Odontologia UFC</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="admin-badge" class="hidden px-2 py-1 bg-red-100 text-red-700 text-[10px] font-bold uppercase rounded-full tracking-wider border border-red-200">Admin</span>
                <button id="back-btn" onclick="navigateTo('home')" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-lg text-sm font-medium transition-colors flex items-center gap-1 active:scale-95">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span class="hidden xs:inline">Voltar</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-4 sm:px-6 py-6 pb-20">

        <!-- ================= VIEW: HOME ================= -->
        <div id="view-home" class="view-section active space-y-8">
            <div class="text-center space-y-2 mb-2">
                <h2 class="text-2xl xs:text-3xl font-bold text-gray-900">Bem-vindo</h2>
                <p class="text-sm xs:text-base text-gray-600 max-w-2xl mx-auto">Selecione uma especialidade ou recurso abaixo.</p>
            </div>

            <!-- Destaque: Protocolos (Blog) -->
            <section>
                <div onclick="navigateTo('blog')" class="btn-card bg-gradient-to-r from-primary to-secondary p-6 rounded-2xl shadow-lg cursor-pointer text-white relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                            <i data-lucide="library" class="w-8 h-8 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-1">Protocolos Clínicos</h3>
                            <p class="text-cyan-100 text-sm">Acesse o banco de dados completo de procedimentos e diretrizes.</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-6 h-6 ml-auto text-white/70 group-hover:text-white group-hover:translate-x-1 transition-all"></i>
                    </div>
                </div>
            </section>

            <!-- Especialidades -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-b border-gray-200 pb-2">
                    <i data-lucide="layout-grid" class="w-5 h-5 text-primary"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Especialidades</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 xs:gap-4">
                    <button onclick="navigateTo('dentistica')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center gap-3 cursor-pointer w-full text-center h-36 xs:h-44">
                        <div class="bg-blue-50 p-3 rounded-full">
                            <i data-lucide="sparkles" class="w-6 h-6 xs:w-8 xs:h-8 text-primary"></i>
                        </div>
                        <span class="font-semibold text-sm xs:text-base text-gray-700">Dentística</span>
                    </button>
                    <!-- Buttons without implementation for now -->
                    <button onclick="showModal('Periodontia')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center gap-3 cursor-pointer w-full text-center h-36 xs:h-44">
                        <div class="bg-red-50 p-3 rounded-full">
                            <i data-lucide="layers" class="w-6 h-6 xs:w-8 xs:h-8 text-rose-600"></i>
                        </div>
                        <span class="font-semibold text-sm xs:text-base text-gray-700">Periodontia</span>
                    </button>
                    <button onclick="showModal('Endodontia')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center gap-3 cursor-pointer w-full text-center h-36 xs:h-44">
                        <div class="bg-indigo-50 p-3 rounded-full">
                            <i data-lucide="arrow-down-to-line" class="w-6 h-6 xs:w-8 xs:h-8 text-indigo-600"></i>
                        </div>
                        <span class="font-semibold text-sm xs:text-base text-gray-700">Endodontia</span>
                    </button>
                    <button onclick="showModal('Cirurgia')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center gap-3 cursor-pointer w-full text-center h-36 xs:h-44">
                        <div class="bg-emerald-50 p-3 rounded-full">
                            <i data-lucide="scissors" class="w-6 h-6 xs:w-8 xs:h-8 text-emerald-600"></i>
                        </div>
                        <span class="font-semibold text-sm xs:text-base text-gray-700">Cirurgia</span>
                    </button>
                </div>
            </section>

            <!-- Outros -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-b border-gray-200 pb-2">
                    <i data-lucide="package-plus" class="w-5 h-5 text-primary"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Recursos</h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button onclick="showModal('Prescrições')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4 w-full text-left active:bg-gray-50">
                        <div class="bg-amber-50 p-3 rounded-lg shrink-0">
                            <i data-lucide="scroll-text" class="w-6 h-6 text-amber-600"></i>
                        </div>
                        <div>
                            <span class="block font-semibold text-gray-700">Prescrições</span>
                            <span class="text-xs text-gray-500">Modelos e posologias</span>
                        </div>
                    </button>
                    <button onclick="showModal('Links Úteis')" class="btn-card bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4 w-full text-left active:bg-gray-50">
                        <div class="bg-gray-100 p-3 rounded-lg shrink-0">
                            <i data-lucide="link" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div>
                            <span class="block font-semibold text-gray-700">Links Úteis</span>
                            <span class="text-xs text-gray-500">CRO, CFO e portais</span>
                        </div>
                    </button>
                </div>
            </section>

            <!-- Manual -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden relative">
                <div class="p-5 flex flex-col md:flex-row items-center md:items-start gap-4">
                    <div class="bg-primary/10 p-3 rounded-xl shrink-0">
                        <i data-lucide="shield-check" class="w-8 h-8 text-primary"></i>
                    </div>
                    <div class="flex-grow text-center md:text-left">
                        <h3 class="text-lg font-bold text-gray-900 mb-1">Manual de Biossegurança</h3>
                        <p class="text-sm text-gray-600 mb-4">Normas, esterilização e EPIs.</p>
                        <button onclick="showModal('Manual de Biossegurança')" class="w-full md:w-auto inline-flex justify-center items-center gap-2 bg-primary hover:bg-secondary text-white font-medium py-3 px-6 rounded-lg transition-colors shadow-sm active:opacity-90">
                            <span>Acessar Manual</span>
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- ================= VIEW: BLOG DE PROTOCOLOS ================= -->
        <div id="view-blog" class="view-section space-y-6">
            <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Protocolos Clínicos</h2>
                        <p class="text-gray-500 text-sm">Base de conhecimento atualizada.</p>
                    </div>
                    <button id="btn-new-protocol" onclick="openEditor()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> Novo
                    </button>
                </div>

                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input type="text" placeholder="Buscar protocolo..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all">
                </div>

                <div id="blog-loader" class="flex justify-center py-10 hidden">
                    <div class="spinner"></div>
                </div>

                <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cards inseridos via JS -->
                </div>
                
                <div id="no-protocols-msg" class="text-center py-10 hidden">
                    <p class="text-gray-500">Nenhum protocolo encontrado.</p>
                    <p class="text-xs text-gray-400 mt-2">Clique em "Área Administrativa" no rodapé para adicionar.</p>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: LEITURA DO PROTOCOLO ================= -->
        <div id="view-post" class="view-section">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[60vh]">
                <div class="bg-gray-50 border-b border-gray-100 p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <span id="post-category" class="inline-block px-2 py-1 rounded-md bg-blue-100 text-blue-700 text-xs font-bold uppercase mb-2">Categoria</span>
                            <h2 id="post-title" class="text-2xl font-bold text-gray-900 leading-tight">Título do Protocolo</h2>
                        </div>
                        <button id="btn-edit-post" class="hidden text-gray-500 hover:text-primary p-2">
                            <i data-lucide="edit-3" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <!-- Classe pre-wrap-text garante que o texto puro seja formatado com quebras de linha -->
                <div id="post-content" class="p-6 text-gray-700 text-sm pre-wrap-text"></div>
            </div>
        </div>

        <!-- ================= VIEW: DENTÍSTICA ================= -->
        <div id="view-dentistica" class="view-section space-y-4">
            <div class="flex items-center gap-3 mb-2 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                <div class="p-2 bg-blue-50 rounded-lg shrink-0">
                    <i data-lucide="sparkles" class="w-6 h-6 text-primary"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-900 leading-tight">Dentística</h2>
                    <p class="text-gray-500 text-xs">Prontuário e Materiais</p>
                </div>
            </div>

            <!-- Abas (Sem Protocolos) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex">
                <button onclick="switchTab('prontuario')" id="tab-btn-prontuario" class="tab-btn active flex-1 py-3 px-4 text-sm font-semibold text-gray-600 hover:text-primary transition-all flex items-center justify-center gap-2">
                    <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                    Prontuário
                </button>
                <button onclick="switchTab('instrumentais')" id="tab-btn-instrumentais" class="tab-btn flex-1 py-3 px-4 text-sm font-semibold text-gray-600 hover:text-primary transition-all flex items-center justify-center gap-2">
                    <i data-lucide="hammer" class="w-4 h-4"></i>
                    Materiais
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 min-h-[400px] mt-2">
                <!-- ABA PRONTUÁRIO -->
                <div id="tab-prontuario" class="tab-content active">
                    <div id="prontuario-menu" class="space-y-3">
                        <button onclick="showProntuarioSection('siglas')" class="w-full p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-blue-50 transition flex items-center gap-4 text-left">
                            <div class="p-3 bg-blue-100 rounded-full text-primary shrink-0"><i data-lucide="type" class="w-5 h-5"></i></div>
                            <div><span class="block font-semibold text-gray-800">Siglas</span><span class="text-xs text-gray-500">Abreviações comuns</span></div>
                            <i data-lucide="chevron-right" class="ml-auto w-5 h-5 text-gray-300"></i>
                        </button>
                        <button onclick="showProntuarioSection('exemplos')" class="w-full p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-blue-50 transition flex items-center gap-4 text-left">
                            <div class="p-3 bg-green-100 rounded-full text-green-700 shrink-0"><i data-lucide="file-check" class="w-5 h-5"></i></div>
                            <div><span class="block font-semibold text-gray-800">Exemplos</span><span class="text-xs text-gray-500">Preenchimento</span></div>
                            <i data-lucide="chevron-right" class="ml-auto w-5 h-5 text-gray-300"></i>
                        </button>
                        <button onclick="showProntuarioSection('odontograma')" class="w-full p-4 border border-gray-200 rounded-xl hover:border-primary hover:bg-blue-50 transition flex items-center gap-4 text-left">
                            <div class="p-3 bg-purple-100 rounded-full text-purple-700 shrink-0"><i data-lucide="grid-3x3" class="w-5 h-5"></i></div>
                            <div><span class="block font-semibold text-gray-800">Odontograma</span><span class="text-xs text-gray-500">Referência visual</span></div>
                            <i data-lucide="chevron-right" class="ml-auto w-5 h-5 text-gray-300"></i>
                        </button>
                    </div>
                    <div id="content-siglas" class="hidden"></div>
                    <div id="content-exemplos" class="hidden"></div>
                    <div id="content-odontograma" class="hidden"></div>
                </div>

                <!-- ABA INSTRUMENTAIS -->
                <div id="tab-instrumentais" class="tab-content">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="hammer" class="w-5 h-5 text-primary"></i> Checklist</h3>
                    <div id="instrumentais-list" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: EDITOR (ADMIN) ================= -->
        <div id="view-editor" class="view-section">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                <h2 class="text-xl font-bold mb-6 text-gray-800">Editor de Protocolo</h2>
                <form id="editor-form" onsubmit="saveProtocol(event)" class="space-y-4">
                    <input type="hidden" id="edit-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="edit-title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="edit-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                            <option value="Dentística">Dentística</option>
                            <option value="Periodontia">Periodontia</option>
                            <option value="Endodontia">Endodontia</option>
                            <option value="Cirurgia">Cirurgia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Resumo (Card)</label>
                        <input type="text" id="edit-summary" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Conteúdo (Texto Puro)</label>
                        <!-- TEXTAREA AGORA É APENAS TEXTO, SEM HTML -->
                        <textarea id="edit-content" rows="12" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none font-sans text-sm placeholder-gray-400" placeholder="Digite o protocolo aqui. Use quebras de linha e hifens (-) para criar listas."></textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="deleteProtocol()" id="btn-delete" class="px-4 py-3 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 hidden">Excluir</button>
                        <div class="flex-grow"></div>
                        <button type="button" onclick="navigateTo('blog')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" id="btn-save" class="px-6 py-3 bg-primary hover:bg-secondary text-white rounded-lg shadow-md flex items-center gap-2">
                            <span>Salvar</span>
                            <div id="save-spinner" class="spinner border-white border-l-transparent w-4 h-4 hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-5xl mx-auto px-4 py-8">
            <div class="flex flex-col items-center gap-6">
                <!-- Admin Button -->
                <button onclick="toggleAdmin()" class="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1 transition-colors">
                    <i data-lucide="lock" class="w-3 h-3"></i>
                    Área Administrativa
                </button>

                <div class="w-full h-px bg-gray-100"></div>

                <div class="flex items-center gap-6 opacity-80 grayscale hover:grayscale-0 transition-all">
                    <!-- Logo Odonto -->
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded-full bg-red-800 flex items-center justify-center text-white border-2 border-red-900"><i data-lucide="activity" class="w-5 h-5"></i></div>
                        <span class="text-[8px] font-bold text-red-900 uppercase">Odonto</span>
                    </div>
                    <div class="w-px h-8 bg-gray-300"></div>
                    <!-- Logo UFC -->
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-10 bg-blue-900 rounded-b-full rounded-t-sm flex items-center justify-center text-white border-2 border-yellow-400 relative overflow-hidden"><span class="text-[8px] font-bold z-10">UFC</span><div class="absolute bottom-0 w-full h-1/2 bg-yellow-400/20 rounded-t-full"></div></div>
                        <div class="flex flex-col">
                            <span class="text-[8px] font-bold text-gray-800 uppercase leading-none">Univ.</span>
                            <span class="text-[8px] font-bold text-gray-800 uppercase leading-none my-0.5">Federal</span>
                            <span class="text-[8px] font-bold text-gray-800 uppercase leading-none">Ceará</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center pt-6"><p class="text-[10px] text-gray-400">&copy; 2024 Guia Clínico - Odontologia UFC.</p></div>
        </div>
    </footer>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xs w-full p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 text-center">Acesso Restrito</h3>
            <input type="password" id="admin-pass" placeholder="Senha" class="w-full p-3 mb-4 border border-gray-300 rounded-lg outline-none focus:border-primary">
            <div class="flex gap-2">
                <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button onclick="checkAdmin()" class="flex-1 py-2 bg-primary text-white rounded-lg hover:bg-secondary">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // =================================================================
        // CONFIGURAÇÃO DO FIREBASE (Chaves fornecidas)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCtPyXA4TJMvxeX3vNdelzvADQTyzVRCfw",
            authDomain: "guia-clinico-odonto.firebaseapp.com",
            projectId: "guia-clinico-odonto",
            storageBucket: "guia-clinico-odonto.firebasestorage.app",
            messagingSenderId: "734059654891",
            appId: "1:734059654891:web:a0f4168725066b054d58ae",
            measurementId: "G-5287NREP2D"
        };

        // Inicialização
        let db;
        let isFirebaseActive = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseActive = true;
            console.log("Firebase conectado com sucesso!");
        } catch (e) {
            console.error("Erro ao iniciar Firebase:", e);
            alert("Erro de conexão com o banco de dados. Verifique o console.");
        }

        lucide.createIcons();

        // --- ESTADO DA APLICAÇÃO ---
        let isAdmin = false;
        let protocols = []; 
        let currentProtocolId = null;

        // Dados padrão (Fallback inicial se o banco estiver vazio - CONVERTIDO PARA TEXTO PURO)
        const defaultProtocols = [
            {
                id: 'demo1',
                title: "Classe I",
                category: "Dentística",
                summary: "Restauração de lesões oclusais com resina composta.",
                content: `1. Diagnóstico (radiografia)
2. Verificação dos contatos oclusais (Papel carbono e Pinça de Willis)
3. Profilaxia (Caneta de baixa, Escova de Robson, Pote Dappen e Pasta profilática)
4. Seleção de cor (90% dos casos - A2, A3 ou A3,5)
5. Anestesia (Carpule e Anestésico)
6. Isolamento absoluto (Lençol, Arco de Young, Perfurador, Grampo, Fio dental, Pinça porta-grampo, Espátula de invaginação)
7. Acesso à lesão (Pontas esféricas em alta rotação)
8. Forma de contorno (se necessário)
9. Remoção de tecido cariado (Broca esférica CA4/CA6 em baixa rotação e colher de dentina)
10. Procedimento Adesivo
- Condicionamento ácido (Ácido fosfórico) 1 - 2 mm aquém das margens por 30 seg
- Lavagem e secagem (dentina por absorção e esmalte com jatos de ar) por 30 seg
- Aplicação do Primer (microbrush)
- Evaporação do solvente (jatos de ar à distância)
- Aplicação do Adesivo (microbrush)
- Fotoativação
11. Inserção incremental da resina composta + Fotoativação
12. Remoção do isolamento
13. Checagem dos contatos oclusais
14. Ajuste oclusal (Pontas diamantadas de granulações finas e extrafinas)
15. Acabamento e polimento (borrachas sequências: verde, amarela e azul) com lubrificação`
            },
            {
                id: 'demo2',
                title: "Classe II - Simples",
                category: "Dentística",
                summary: "Técnica do slot horizontal (estritamente proximal).",
                content: `1. Profilaxia.
2. Seleção de cor (90% dos casos - A2, A3 ou A3,5).
3. Anestesia infiltrativa (Lidocaína 2%).
4. Isolamento absoluto:
- Verificação dos contatos proximais (fio dental).
- Ajuste dos contatos proximais (tira de lixa).
- Seleção e teste do grampo.
- Colocação do lençol de borracha no arco.
- Posição do conjunto arco/lençol na face do paciente.
- Marcação dos dentes que serão isolados.
- Perfuração do dique de borracha.
- Lubrificação da superfície interna.
- Passar os dentes pelo lençol de borracha.
- Instalação dos grampos e estabilização do lençol.
5. Preparo cavitário:
- Proteção do dente adjacente com matriz metálica.
- Remoção de tecido cariado/restauração defeituosa.
- Limpeza da cavidade.
6. Procedimento adesivo:
- Proteção do dente adjacente com tira de poliéster.
- Condicionamento ácido (1 - 2 mm além das margens).
- Lavagem e secagem: Dentina com algodão, Esmalte com jatos de ar.
- Aplicação do Primer (microbrush).
- Evaporação do solvente (jatos de ar à distância).
- Aplicação do Adesivo (microbrush).
- Fotoativação.
7. Inserção incremental da resina composta + Fotoativação.
8. Acabamento e polimento:
- Lâmina número 12.
- Tiras de granulação fina.`
            },
            {
                id: 'demo3',
                title: "Classe II - Composta",
                category: "Dentística",
                summary: "Técnica da matriz metálica parcial biconvexa.",
                content: `1. Diagnóstico.
2. Aferição dos contatos oclusais.
3. Profilaxia.
4. Seleção de cor.
5. Anestesia.
6. Isolamento absoluto:
- Teste do grampo.
7. Preparo cavitário: remoção de tecido cariado/restauração defeituosa:
- (Proteger o dente adjacente com matriz metálica).
8. Procedimento adesivo:
- O procedimento adesivo deve ser realizado antes da adaptação da matriz. Será realizado após a adaptação da matriz quando esta atua como isolante nos casos de isolamento relativo.
- Condicionamento ácido (1-2 mm além das margens):
  - Aplica em esmalte - 15 seg.
  - Estende p/ dentina - 15 seg.
- Lavagem e secagem (dentina com algodão e esmalte com jatos de ar).
- Aplicação do Primer (microbrush).
- Evaporação do solvente (jatos de ar à distância).
- Aplicação do Adesivo (microbrush).
- Fotoativação.
9. Adaptação da matriz metálica e estabilização com cunha.
10. Inserção incremental da resina + Fotoativação:
- Inicia pela caixa proximal com incrementos oblíquos.
- Para compensar a distância entre o fotopolimerizador e o incremento, aumentar o tempo de fotopolimerização.
- Remoção da matriz.
- Finaliza a inserção da resina na oclusal.
11. Remoção do isolamento.
12. Checagem dos contatos oclusais + Ajuste oclusal (Pontas diamantadas de granulação fina e extrafina).
13. Acabamento: Discos abrasivos flexíveis, tiras de lixa (proximal).
14. Polimento: borrachas abrasivas sequenciais em ordem decrescente / escovas abrasivas especiais.`
            }
        ];

        // --- NAVEGAÇÃO ---
        function navigateTo(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            window.scrollTo(0, 0);

            const backBtn = document.getElementById('back-btn');
            if (viewId === 'home') backBtn.classList.add('hidden');
            else backBtn.classList.remove('hidden');

            if (viewId === 'blog') loadProtocols();
            if (viewId === 'dentistica') renderProntuarioContent();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // --- LÓGICA DO FIREBASE / BLOG ---
        async function loadProtocols() {
            const grid = document.getElementById('blog-grid');
            const loader = document.getElementById('blog-loader');
            const noMsg = document.getElementById('no-protocols-msg');
            
            grid.innerHTML = '';
            loader.classList.remove('hidden');
            noMsg.classList.add('hidden');

            try {
                if (isFirebaseActive) {
                    const snapshot = await db.collection('protocols').orderBy('title').get();
                    if (!snapshot.empty) {
                        protocols = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else {
                        // Se vazio, usa os defaults (apenas para visualização inicial)
                        protocols = defaultProtocols;
                    }
                } else {
                    // Modo Offline
                    protocols = JSON.parse(localStorage.getItem('gc_protocols')) || defaultProtocols;
                }
            } catch (error) {
                console.error("Erro ao carregar:", error);
                protocols = defaultProtocols; // Fallback
            }

            loader.classList.add('hidden');

            if (protocols.length === 0) {
                noMsg.classList.remove('hidden');
                return;
            }

            protocols.forEach(post => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer flex flex-col h-full animate-[fadeIn_0.5s]";
                card.onclick = () => openPost(post.id);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-bold text-primary bg-blue-50 px-2 py-1 rounded">${post.category}</span>
                        ${isAdmin ? `<button onclick="event.stopPropagation(); editPost('${post.id}')" class="text-gray-400 hover:text-blue-600"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">${post.title}</h3>
                    <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">${post.summary}</p>
                    <div class="flex items-center text-primary text-sm font-medium mt-auto">
                        Ler protocolo <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
            
            const newBtn = document.getElementById('btn-new-protocol');
            if(isAdmin) newBtn.classList.remove('hidden');
            else newBtn.classList.add('hidden');
        }

        function openPost(id) {
            const post = protocols.find(p => p.id === id);
            if (!post) return;

            document.getElementById('post-category').textContent = post.category;
            document.getElementById('post-title').textContent = post.title;
            // Injeta o texto puro. A classe CSS .pre-wrap-text cuidará da formatação
            document.getElementById('post-content').textContent = post.content;
            
            const editBtn = document.getElementById('btn-edit-post');
            if(isAdmin) {
                editBtn.classList.remove('hidden');
                editBtn.onclick = () => editPost(id);
            } else {
                editBtn.classList.add('hidden');
            }

            navigateTo('post');
        }

        // --- ADMIN / EDITOR ---
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('admin-badge').classList.add('hidden');
                alert("Modo Administrador desativado.");
                navigateTo('home');
            } else {
                document.getElementById('admin-modal').classList.remove('hidden');
            }
        }

        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            if (pass === 'admin') { 
                isAdmin = true;
                document.getElementById('admin-modal').classList.add('hidden');
                document.getElementById('admin-badge').classList.remove('hidden');
                document.getElementById('admin-pass').value = '';
                if(document.getElementById('view-blog').classList.contains('active')) loadProtocols();
            } else {
                alert("Senha incorreta!");
            }
        }

        function openEditor() {
            document.getElementById('editor-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('btn-delete').classList.add('hidden');
            navigateTo('editor');
        }

        function editPost(id) {
            const post = protocols.find(p => p.id === id);
            if (!post) return;

            document.getElementById('edit-id').value = post.id;
            document.getElementById('edit-title').value = post.title;
            document.getElementById('edit-category').value = post.category;
            document.getElementById('edit-summary').value = post.summary;
            document.getElementById('edit-content').value = post.content;
            document.getElementById('btn-delete').classList.remove('hidden');
            
            navigateTo('editor');
        }

        async function saveProtocol(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const spinner = document.getElementById('save-spinner');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');

            const idInput = document.getElementById('edit-id').value;
            const data = {
                title: document.getElementById('edit-title').value,
                category: document.getElementById('edit-category').value,
                summary: document.getElementById('edit-summary').value,
                content: document.getElementById('edit-content').value,
                updatedAt: new Date()
            };

            try {
                if (isFirebaseActive) {
                    if (idInput && !idInput.startsWith('demo')) {
                        await db.collection('protocols').doc(idInput).update(data);
                    } else {
                        await db.collection('protocols').add(data);
                    }
                } else {
                    let localProts = JSON.parse(localStorage.getItem('gc_protocols')) || [];
                    if(idInput) {
                        const idx = localProts.findIndex(p => p.id == idInput);
                        if(idx > -1) localProts[idx] = { id: idInput, ...data };
                    } else {
                        localProts.push({ id: Date.now().toString(), ...data });
                    }
                    localStorage.setItem('gc_protocols', JSON.stringify(localProts));
                }
                navigateTo('blog');
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar.");
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        async function deleteProtocol() {
            const idInput = document.getElementById('edit-id').value;
            if(!confirm("Tem certeza que deseja excluir?")) return;

            if (isFirebaseActive && !idInput.startsWith('demo')) {
                await db.collection('protocols').doc(idInput).delete();
            } else {
                let localProts = JSON.parse(localStorage.getItem('gc_protocols')) || [];
                localProts = localProts.filter(p => p.id != idInput);
                localStorage.setItem('gc_protocols', JSON.stringify(localProts));
            }
            navigateTo('blog');
        }

        // --- LEGADO: Prontuário ---
        function renderProntuarioContent() {
            document.getElementById('content-siglas').innerHTML = `
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold flex gap-2"><i data-lucide="type" class="w-5 text-primary"></i> Siglas</h3><button onclick="hideProntuarioSections()" class="text-xs bg-gray-100 px-3 py-1 rounded-full">Voltar</button></div>
                <div class="grid grid-cols-1 gap-2 text-sm h-[60vh] overflow-y-auto">
                    <div class="text-xs font-bold text-gray-400 uppercase mt-1">Gerais</div>
                    <div class="bg-gray-50 p-2 rounded border flex justify-between"><span class="font-bold text-primary">DA</span><span class="text-xs">Diário alimentar</span></div>
                    <div class="bg-gray-50 p-2 rounded border flex justify-between"><span class="font-bold text-primary">ODG</span><span class="text-xs">Odontograma</span></div>
                    <div class="text-xs font-bold text-gray-400 uppercase mt-2">Preparos</div>
                    <div class="bg-indigo-50 p-2 rounded border flex justify-between"><span class="font-bold text-indigo-700">PCCLI</span><span class="text-xs">Classe I</span></div>
                    <div class="bg-indigo-50 p-2 rounded border flex justify-between"><span class="font-bold text-indigo-700">PCCLII</span><span class="text-xs">Classe II</span></div>
                </div>
            `;
            
            const instList = document.getElementById('instrumentais-list');
            if(instList.innerHTML === '') {
               instList.innerHTML = `
                <details class="group bg-gray-50 p-3 rounded-lg border border-gray-200"><summary class="font-medium cursor-pointer">Carrinho/Bancada</summary><ul class="text-xs mt-2 pl-4 list-disc text-gray-600"><li>Anestésico + Agulha</li><li>Isolamento (Lençol, Arco)</li><li>Adesivo + Resina + Ácido</li></ul></details>
                <details class="group bg-gray-50 p-3 rounded-lg border border-gray-200"><summary class="font-medium cursor-pointer">CME (Estéril)</summary><ul class="text-xs mt-2 pl-4 list-disc text-gray-600"><li>Kit Dentística</li><li>Canetas Alta/Baixa</li><li>Espátula 24</li></ul></details>
               `;
            }
            lucide.createIcons();
        }

        function showProntuarioSection(id) {
            document.getElementById('prontuario-menu').classList.add('hidden');
            document.querySelectorAll('#tab-prontuario > div:not(#prontuario-menu)').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${id}`).classList.remove('hidden');
        }
        function hideProntuarioSections() {
            document.querySelectorAll('#tab-prontuario > div:not(#prontuario-menu)').forEach(el => el.classList.add('hidden'));
            document.getElementById('prontuario-menu').classList.remove('hidden');
        }

        function showModal(title) { alert(`Seção ${title} em desenvolvimento.`); }
        
        renderProntuarioContent();
    </script>
</body>
</html>
